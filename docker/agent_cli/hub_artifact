#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<'USAGE'
Usage:
  hub_artifact publish <path> [<path> ...] [--name <display-name>]

Notes:
  - If a supplied path is a directory, all files directly inside it are published.
  - Subdirectories are not supported and will cause an error.
  - --name is only valid when publishing exactly one file.

Environment variables:
  AGENT_HUB_ARTIFACTS_URL   publish endpoint URL injected by Agent Hub
  AGENT_HUB_ARTIFACT_TOKEN  per-chat publish token injected by Agent Hub
  HUB_ARTIFACT_MAX_ATTEMPTS optional per-file upload attempts (default: 8)
  HUB_ARTIFACT_RETRY_DELAY_BASE_SEC optional exponential backoff base delay (default: 1)
  HUB_ARTIFACT_RETRY_DELAY_MAX_SEC optional exponential backoff max delay (default: 30)
  HUB_ARTIFACT_CONNECT_TIMEOUT_SEC optional per-request connect timeout (default: 10)
  HUB_ARTIFACT_REQUEST_TIMEOUT_SEC optional per-request max duration (default: 120)
  HUB_ARTIFACT_PROGRESS_EVERY optional progress interval in files (default: 25)
USAGE
}

if [[ "${1:-}" != "publish" ]]; then
  usage >&2
  exit 2
fi
shift

artifact_name=""
input_paths=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --name)
      if [[ $# -lt 2 ]]; then
        echo "Missing value for --name." >&2
        exit 2
      fi
      artifact_name="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      input_paths+=("$1")
      shift
      ;;
  esac
done

if [[ ${#input_paths[@]} -eq 0 ]]; then
  usage >&2
  exit 2
fi

if [[ -z "${AGENT_HUB_ARTIFACTS_URL:-}" ]]; then
  echo "AGENT_HUB_ARTIFACTS_URL is not set. Start this session from Agent Hub." >&2
  exit 1
fi

if [[ -z "${AGENT_HUB_ARTIFACT_TOKEN:-}" ]]; then
  echo "AGENT_HUB_ARTIFACT_TOKEN is not set. Start this session from Agent Hub." >&2
  exit 1
fi

require_int_ge() {
  local name="$1"
  local value="$2"
  local minimum="$3"
  if [[ ! "${value}" =~ ^[0-9]+$ ]] || (( value < minimum )); then
    echo "${name} must be an integer >= ${minimum}." >&2
    exit 2
  fi
}

max_attempts="${HUB_ARTIFACT_MAX_ATTEMPTS:-8}"
retry_delay_base_sec="${HUB_ARTIFACT_RETRY_DELAY_BASE_SEC:-1}"
retry_delay_max_sec="${HUB_ARTIFACT_RETRY_DELAY_MAX_SEC:-30}"
connect_timeout_sec="${HUB_ARTIFACT_CONNECT_TIMEOUT_SEC:-10}"
request_timeout_sec="${HUB_ARTIFACT_REQUEST_TIMEOUT_SEC:-120}"
progress_every="${HUB_ARTIFACT_PROGRESS_EVERY:-25}"

require_int_ge "HUB_ARTIFACT_MAX_ATTEMPTS" "${max_attempts}" 1
require_int_ge "HUB_ARTIFACT_RETRY_DELAY_BASE_SEC" "${retry_delay_base_sec}" 0
require_int_ge "HUB_ARTIFACT_RETRY_DELAY_MAX_SEC" "${retry_delay_max_sec}" 0
require_int_ge "HUB_ARTIFACT_CONNECT_TIMEOUT_SEC" "${connect_timeout_sec}" 1
require_int_ge "HUB_ARTIFACT_REQUEST_TIMEOUT_SEC" "${request_timeout_sec}" 1
require_int_ge "HUB_ARTIFACT_PROGRESS_EVERY" "${progress_every}" 1

upload_paths=()

for source_path in "${input_paths[@]}"; do
  if [[ -d "${source_path}" ]]; then
    while IFS= read -r -d '' entry; do
      if [[ -d "${entry}" ]]; then
        echo "Subdirectories are not supported for artifact publish: ${entry}" >&2
        exit 1
      fi
      if [[ ! -f "${entry}" ]]; then
        echo "Artifact path is not a regular file: ${entry}" >&2
        exit 1
      fi
      upload_paths+=("${entry}")
    done < <(find "${source_path}" -mindepth 1 -maxdepth 1 -print0 | sort -z)
    continue
  fi

  if [[ ! -e "${source_path}" ]]; then
    echo "Artifact file not found: ${source_path}" >&2
    exit 1
  fi
  if [[ ! -f "${source_path}" ]]; then
    echo "Artifact path is not a regular file: ${source_path}" >&2
    exit 1
  fi
  upload_paths+=("${source_path}")
done

if [[ ${#upload_paths[@]} -eq 0 ]]; then
  echo "No files found to publish." >&2
  exit 1
fi

if [[ -n "${artifact_name}" && ${#upload_paths[@]} -ne 1 ]]; then
  echo "--name can only be used when publishing exactly one file." >&2
  exit 2
fi

publish_one() {
  local path="$1"
  local name="$2"

  local payload
  payload="$(
    python3 - "${path}" "${name}" <<'PY'
import json
import sys

path = sys.argv[1]
name = sys.argv[2]
body = {"path": path}
if name:
    body["name"] = name
sys.stdout.write(json.dumps(body))
PY
  )"

  local response
  if ! response="$(
    curl -fsS \
      --connect-timeout "${connect_timeout_sec}" \
      --max-time "${request_timeout_sec}" \
      -X POST \
      -H "Authorization: Bearer ${AGENT_HUB_ARTIFACT_TOKEN}" \
      -H "Content-Type: application/json" \
      --data "${payload}" \
      "${AGENT_HUB_ARTIFACTS_URL}"
  )"; then
    return 1
  fi

  python3 - "${path}" "${response}" <<'PY'
import json
import sys
from pathlib import Path

submitted_path = sys.argv[1]
raw = str(sys.argv[2]).strip()

if not raw:
    print(f"Artifact published: {Path(submitted_path).name}")
    sys.exit(0)

try:
    payload = json.loads(raw)
except json.JSONDecodeError:
    print(f"Artifact published: {Path(submitted_path).name}")
    sys.exit(0)

artifact = payload.get("artifact") if isinstance(payload, dict) else None
if not isinstance(artifact, dict):
    print(f"Artifact published: {Path(submitted_path).name}")
    sys.exit(0)

name = str(artifact.get("name") or artifact.get("relative_path") or Path(submitted_path).name)
download_url = str(artifact.get("download_url") or "").strip()
if download_url:
    print(f"Artifact published: {name} ({download_url})")
else:
    print(f"Artifact published: {name}")
PY
}

published_count=0
failed_count=0
failed_paths=()
processed_count=0
total_uploads=${#upload_paths[@]}
for path in "${upload_paths[@]}"; do
  name_arg=""
  if [[ ${#upload_paths[@]} -eq 1 ]]; then
    name_arg="${artifact_name}"
  fi
  attempt=1
  while true; do
    if publish_one "${path}" "${name_arg}"; then
      published_count=$((published_count + 1))
      break
    fi
    if [[ "${attempt}" -ge "${max_attempts}" ]]; then
      echo "Artifact publish failed after ${attempt} attempt(s): ${path}" >&2
      failed_count=$((failed_count + 1))
      failed_paths+=("${path}")
      break
    fi
    delay="${retry_delay_base_sec}"
    retry_level=$((attempt - 1))
    while (( retry_level > 0 && delay < retry_delay_max_sec )); do
      delay=$((delay * 2))
      if (( delay > retry_delay_max_sec )); then
        delay="${retry_delay_max_sec}"
      fi
      retry_level=$((retry_level - 1))
    done
    attempt=$((attempt + 1))
    echo "Retrying artifact publish (${attempt}/${max_attempts}): ${path} (sleep ${delay}s)" >&2
    if (( delay > 0 )); then
      sleep "${delay}"
    fi
  done
  processed_count=$((processed_count + 1))
  if (( total_uploads >= progress_every )) && (( processed_count % progress_every == 0 || processed_count == total_uploads )); then
    echo "Artifact upload progress: ${processed_count}/${total_uploads} processed; ${published_count} succeeded; ${failed_count} failed." >&2
  fi
done

if [[ ${published_count} -gt 1 ]]; then
  echo "Published ${published_count} artifacts."
fi

if [[ ${failed_count} -gt 0 ]]; then
  echo "Failed to publish ${failed_count} artifact(s):" >&2
  for failed_path in "${failed_paths[@]}"; do
    echo "  - ${failed_path}" >&2
  done
  exit 1
fi
